<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Scanner CAEd Sync | Raquel Aguiar</title>
    <link rel="icon" href="https://fav.farm/üì∏" />
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; width: 100%; max-width: 450px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn-foto { background: #28a745; color: white; border: none; padding: 20px; border-radius: 10px; font-size: 18px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px; }
        input, select { padding: 12px; margin: 5px 0; width: 100%; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .item-aluno { background: white; padding: 10px; margin-top: 5px; border-radius: 5px; border-left: 5px solid #007bff; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { background: #d4edda; color: #155724; padding: 5px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; width: 100%; text-align: center; }
    </style>
</head>
<body>

<div id="statusSync" class="status-badge">Conectando ao Firebase...</div>

<div class="card">
    <strong>‚öôÔ∏è Configura√ß√£o do Teste</strong>
    <select id="turma" onchange="atualizarEscuta()"><option value="8ano">8¬∫ Ano</option><option value="9ano">9¬∫ Ano</option></select>
    <input type="text" id="testeID" placeholder="Ex: Teste01" oninput="atualizarEscuta()">
    <input type="text" id="gabaritoOficial" placeholder="Gabarito Oficial (Ex: ABCD...)">
</div>

<div class="card">
    <strong>üì∏ Scanner do Aluno</strong>
    <input type="text" id="nomeAluno" placeholder="Nome do Aluno">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="processarCaptura(event)">
    <button class="btn-foto" onclick="abrirCamera()">üì∑ TIRAR FOTO DO GABARITO</button>
</div>

<div style="width: 100%; max-width: 450px;">
    <h4>Sincronizado no Notebook:</h4>
    <div id="listaResultados"></div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://gestao-caed-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Sincroniza√ß√£o de status
    db.ref('.info/connected').on('value', snap => {
        document.getElementById('statusSync').innerText = snap.val() ? "Sincroniza√ß√£o Ativa ‚úÖ" : "Offline ‚ùå";
    });

    function abrirCamera() {
        const nome = document.getElementById('nomeAluno').value;
        if (!nome) return alert("Digite o nome do aluno antes de tirar a foto!");
        document.getElementById('cameraInput').click();
    }

    function processarCaptura(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            // Aqui salvamos os dados. A "corre√ß√£o" baseada na foto 
            // requer processamento posterior ou confer√™ncia manual no notebook.
            enviarParaFirebase(e.target.result);
        };
        reader.readAsDataURL(file);
    }

    function enviarParaFirebase(fotoData) {
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeID').value || "Geral";
        const nome = document.getElementById('nomeAluno').value;
        const gabarito = document.getElementById('gabaritoOficial').value;

        const ref = db.ref(`escola/${turma}/${teste}`);
        ref.push({
            aluno: nome,
            data: 20260218,
            gabaritoOficial: gabarito,
            fotoProcessada: "Sim", // Indica que a imagem foi capturada
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            document.getElementById('nomeAluno').value = "";
            alert("Sincronizado com o Notebook!");
        });
    }

    let escutaAtiva = null;
    function atualizarEscuta() {
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeID').value || "Geral";
        const lista = document.getElementById('listaResultados');

        if (escutaAtiva) escutaAtiva.off();
        escutaAtiva = db.ref(`escola/${turma}/${teste}`);
        
        escutaAtiva.on('value', (snapshot) => {
            lista.innerHTML = "";
            snapshot.forEach((child) => {
                const d = child.val();
                const item = document.createElement('div');
                item.className = 'item-aluno';
                item.innerHTML = `<span>${d.aluno}</span> <small>‚úÖ Recebido</small>`;
                lista.prepend(item);
            });
        });
    }

    atualizarEscuta();
</script>
</body>
</html>
