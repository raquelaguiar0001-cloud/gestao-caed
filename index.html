<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema CAEd | Raquel Aguiar</title>
    <link rel="icon" href="https://fav.farm/üìä" />
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .status-sync { background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; width: 100%; text-align: center; font-weight: bold; margin-bottom: 10px; }
        .resultado-item { background: white; padding: 15px; margin-top: 10px; border-radius: 10px; border-left: 6px solid #007bff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nota-badge { background: #28a745; color: white; padding: 5px 10px; border-radius: 6px; font-weight: bold; font-size: 14px; }
        input, select { padding: 12px; margin: 5px 0; width: 100%; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .btn-foto { background: #28a745; color: white; border: none; padding: 18px; border-radius: 12px; width: 100%; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-foto:active { transform: scale(0.98); background: #218838; }
    </style>
</head>
<body>

<div id="status" class="status-sync">Sincroniza√ß√£o Ativa ‚úÖ</div>

<div class="card">
    <strong>‚öôÔ∏è Configura√ß√£o Fixa (8¬∫ e 9¬∫ Ano)</strong>
    <select id="turma" onchange="salvarEAtualizar()"><option value="8ano">8¬∫ Ano</option><option value="9ano">9¬∫ Ano</option></select>
    <input type="text" id="testeID" placeholder="Nome do Teste (Ex: Teste 01)" oninput="salvarEAtualizar()">
    <input type="text" id="gabaritoOficial" placeholder="Gabarito (Ex: ABCD...)" oninput="salvarEAtualizar()" style="font-weight: bold; letter-spacing: 1px;">
</div>

<div class="card">
    <strong>üì∏ Scanner de Gabarito</strong>
    <input type="text" id="nomeAluno" placeholder="Nome do Aluno">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="processarEEnviar(event)">
    <button class="btn-foto" onclick="document.getElementById('cameraInput').click()">üì∑ TIRAR FOTO E CALCULAR NOTA</button>
</div>

<div id="painelNotebook" style="width: 100%; max-width: 500px;">
    <h4>üìä Resultados e Desempenho (Tempo Real):</h4>
    <div id="listaResultados"></div>
</div>

<script>
    // Configura√ß√£o oficial para o seu banco na Europa
    const firebaseConfig = { databaseURL: "https://gestao-caed-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Carrega dados salvos no navegador ao abrir
    window.onload = () => {
        document.getElementById('testeID').value = localStorage.getItem('testeID') || "Teste 01";
        document.getElementById('gabaritoOficial').value = localStorage.getItem('gabaritoOficial') || "1D2B3A4D5A6B7D8D9A10D11B12A";
        document.getElementById('turma').value = localStorage.getItem('turma') || "8ano";
        atualizarEscuta();
    };

    function salvarEAtualizar() {
        localStorage.setItem('testeID', document.getElementById('testeID').value);
        localStorage.setItem('gabaritoOficial', document.getElementById('gabaritoOficial').value);
        localStorage.setItem('turma', document.getElementById('turma').value);
        atualizarEscuta();
    }

    function processarEEnviar(event) {
        const nome = document.getElementById('nomeAluno').value;
        const oficial = document.getElementById('gabaritoOficial').value.toUpperCase().replace(/[^A-Z]/g, '');
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeID').value;

        if (!nome) return alert("Por favor, digite o nome do aluno!");

        // Simula a leitura para gerar o desempenho imediato no notebook
        // Em um sistema real, aqui entraria a leitura da imagem
        const acertos = Math.floor(Math.random() * (oficial.length + 1)); 
        const perc = ((acertos / oficial.length) * 100).toFixed(0);

        db.ref(`escola/${turma}/${teste}`).push({
            aluno: nome,
            nota: acertos,
            total: oficial.length,
            desempenho: perc + "%",
            data: 20260218 // Formato num√©rico solicitado
        }).then(() => {
            document.getElementById('nomeAluno').value = "";
            alert("Sincronizado com sucesso!");
        });
    }

    let listener = null;
    function atualizarEscuta() {
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeID').value || "Geral";
        const lista = document.getElementById('listaResultados');

        if (listener) listener.off();
        listener = db.ref(`escola/${turma}/${teste}`);

        listener.on('value', (snapshot) => {
            lista.innerHTML = "";
            snapshot.forEach((child) => {
                const d = child.val();
                const item = document.createElement('div');
                item.className = 'resultado-item';
                item.innerHTML = `
                    <div>
                        <strong>${d.aluno}</strong><br>
                        <small style="color:#666">Desempenho: ${d.desempenho}</small>
                    </div>
                    <span class="nota-badge">${d.nota}/${d.total}</span>
                `;
                lista.prepend(item);
            });
        });
    }
</script>
</body>
</html>
