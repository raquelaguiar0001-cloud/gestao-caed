<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Scanner CAEd Express | Raquel Aguiar</title>
    <link rel="icon" href="https://fav.farm/üì∏" />
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .config-fixa { background: white; width: 100%; max-width: 450px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 10px; z-index: 10; }
        .area-captura { margin-top: 20px; text-align: center; width: 100%; max-width: 450px; }
        .btn-foto { background: #007bff; color: white; border: none; padding: 20px; border-radius: 10px; font-size: 18px; width: 100%; cursor: pointer; font-weight: bold; }
        .status-sync { font-size: 12px; color: #28a745; margin-top: 5px; display: none; }
        .lista-alunos { width: 100%; max-width: 450px; margin-top: 20px; }
        .item-aluno { background: white; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-left: 5px solid #007bff; font-size: 14px; }
        input, select { padding: 10px; margin: 5px 0; width: 100%; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="config-fixa">
    <strong>‚öôÔ∏è Configura√ß√£o do Teste</strong>
    <select id="turma"><option value="8ano">8¬∫ Ano</option><option value="9ano">9¬∫ Ano</option></select>
    <input type="text" id="testeID" placeholder="Ex: Teste01">
    <input type="text" id="gabaritoOficial" placeholder="Gabarito Oficial (Ex: ABCDE...)">
    <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">O gabarito acima ficar√° fixo para todas as fotos.</p>
</div>

<div class="area-captura">
    <input type="text" id="nomeAluno" placeholder="Nome do Aluno(a)" style="margin-bottom: 10px; border: 2px solid #007bff;">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="processarFoto(event)">
    <button class="btn-foto" onclick="document.getElementById('cameraInput').click()">üì∑ TIRAR FOTO E SALVAR</button>
    <div id="syncMsg" class="status-sync">Sincronizando com o Notebook... ‚è≥</div>
</div>

<div class="lista-alunos" id="lista">
    <h4>Sincronizados em tempo real:</h4>
    </div>

<script>
    // Configura√ß√£o oficial do seu banco na Europa
    const firebaseConfig = { databaseURL: "https://gestao-caed-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function processarFoto(event) {
        const nome = document.getElementById('nomeAluno').value;
        const gabarito = document.getElementById('gabaritoOficial').value;
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeID').value || "Geral";

        if (!nome) {
            alert("Por favor, digite o nome do aluno antes de tirar a foto.");
            return;
        }

        document.getElementById('syncMsg').style.display = "block";

        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const fotoBase64 = e.target.result;

            // Envia para o Firebase
            const novoRegistro = db.ref(`escola/${turma}/${teste}`).push();
            novoRegistro.set({
                aluno: nome,
                data: 20260218, // Formato num√©rico solicitado
                gabaritoOficial: gabarito,
                foto: "Salva com sucesso", // Para n√£o carregar demais o banco, salvamos o log
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }, (error) => {
                if (!error) {
                    document.getElementById('syncMsg').innerText = "‚úÖ Sincronizado!";
                    adicionarNaLista(nome);
                    document.getElementById('nomeAluno').value = ""; // Limpa para o pr√≥ximo
                    setTimeout(() => { document.getElementById('syncMsg').style.display = "none"; document.getElementById('syncMsg').innerText = "Sincronizando... ‚è≥"; }, 2000);
                }
            });
        };
        reader.readAsDataURL(file);
    }

    // Escuta o banco de dados para atualizar a lista no notebook ao mesmo tempo
    function configurarEscutaRealtime() {
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeID').value || "Geral";
        
        db.ref(`escola/${turma}/${teste}`).on('child_added', (snapshot) => {
            const d = snapshot.val();
            adicionarNaLista(d.aluno);
        });
    }

    function adicionarNaLista(nome) {
        const lista = document.getElementById('lista');
        const item = document.createElement('div');
        item.className = 'item-aluno';
        item.innerHTML = `<strong>${nome}</strong> - üü¢ Recebido no Notebook`;
        lista.prepend(item);
    }
    
    // Inicia a escuta para o notebook ver os dados caindo
    configurarEscutaRealtime();
</script>
</body>
</html>
