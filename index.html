<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema CAEd | Raquel Aguiar</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .aba-container { display: flex; gap: 10px; margin-bottom: 10px; width: 100%; }
        .aba { flex: 1; padding: 12px; text-align: center; cursor: pointer; background: #ddd; border-radius: 8px 8px 0 0; font-weight: bold; }
        .aba.ativa { background: white; border-bottom: 4px solid #007bff; color: #007bff; }
        .item-aluno { border-bottom: 1px solid #eee; padding: 10px 0; }
        .aluno-topo { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .detalhes-correcao { display: none; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px dashed #ccc; }
        .questao-box { display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; margin: 2px; border-radius: 6px; font-weight: bold; font-size: 11px; color: white; }
        .acerto { background: #28a745; }
        .erro { background: #dc3545; }
        .barra-fundo { background: #eee; height: 12px; border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .barra-progresso { background: #007bff; height: 100%; transition: 0.5s; }
        input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; margin-top: 5px; }
        .btn-foto { background: #28a745; color: white; border: none; font-weight: bold; font-size: 16px; cursor: pointer; padding: 18px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h3>üìÇ Pastas de Testes</h3>
        <select id="turma" onchange="trocarPasta()"><option value="8ano">8¬∫ Ano</option><option value="9ano">9¬∫ Ano</option></select>
        <input type="text" id="testeID" placeholder="Nome do Teste" oninput="trocarPasta()">
        <input type="text" id="gabaritoOficial" placeholder="Gabarito (Ex: 1A2B3C...)" oninput="salvarGabarito()">
    </div>

    <div class="card">
        <strong>üì∏ Scanner do Aluno</strong>
        <input type="text" id="nomeAluno" placeholder="Nome do Aluno">
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="processarEnvio(event)">
        <button class="btn-foto" onclick="document.getElementById('cameraInput').click()">üì∑ TIRAR FOTO E SINCRONIZAR</button>
    </div>

    <div class="aba-container">
        <div id="aba1" class="aba ativa" onclick="mudarAba(1)">üë• Alunos</div>
        <div id="aba2" class="aba" onclick="mudarAba(2)">üìä Desempenho Geral</div>
    </div>

    <div id="contAba1" class="card">
        <div id="listaAlunos">Aguardando dados...</div>
    </div>

    <div id="contAba2" class="card" style="display:none;">
        <h4>M√©dia Geral de Acertos: <span id="txtMedia">0%</span></h4>
        <div class="barra-fundo"><div id="barraMedia" class="barra-progresso" style="width: 0%"></div></div>
        <hr>
        <h4>Defasagem por Habilidade</h4>
        <div id="diagHabilidades">Analisando...</div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://gestao-caed-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Mapeamento fixo para evitar o erro "undefined"
    const habilidades = {
        "D041": "Gera√ß√£o de Energia",
        "D042": "Reprodu√ß√£o e Contracep√ß√£o",
        "D025": "Estrutura da Terra",
        "D095": "Impactos Ambientais"
    };

    window.onload = () => {
        document.getElementById('testeID').value = localStorage.getItem('testeID') || "Teste_01";
        document.getElementById('turma').value = localStorage.getItem('turma') || "8ano";
        document.getElementById('gabaritoOficial').value = localStorage.getItem('gabaritoOficial') || "";
        atualizarEscuta();
    };

    function trocarPasta() {
        localStorage.setItem('testeID', document.getElementById('testeID').value);
        localStorage.setItem('turma', document.getElementById('turma').value);
        atualizarEscuta();
    }

    function salvarGabarito() {
        localStorage.setItem('gabaritoOficial', document.getElementById('gabaritoOficial').value);
        atualizarEscuta();
    }

    function mudarAba(n) {
        document.getElementById('contAba1').style.display = n === 1 ? 'block' : 'none';
        document.getElementById('contAba2').style.display = n === 2 ? 'block' : 'none';
        document.getElementById('aba1').className = n === 1 ? 'aba ativa' : 'aba';
        document.getElementById('aba2').className = n === 2 ? 'aba ativa' : 'aba';
    }

    function processarEnvio(event) {
        const oficial = document.getElementById('gabaritoOficial').value.toUpperCase();
        const nome = document.getElementById('nomeAluno').value;
        if(!nome || !oficial) return alert("Preencha o nome e o gabarito oficial primeiro!");

        // Simula√ß√£o da leitura da foto gerando respostas para o banco
        let resp = ""; let acertos = 0;
        for(let i=0; i < oficial.length; i++) {
            let letra = Math.random() > 0.4 ? oficial[i] : "X";
            resp += letra;
            if(letra === oficial[i]) acertos++;
        }

        db.ref(`escola/${document.getElementById('turma').value}/${document.getElementById('testeID').value}`).push({
            aluno: nome, respostas: resp, acertos: acertos, total: oficial.length,
            falha: acertos < (oficial.length * 0.6) ? Object.keys(habilidades)[Math.floor(Math.random()*4)] : "Nenhuma"
        }).then(() => { document.getElementById('nomeAluno').value = ""; });
    }

    let refAtiva = null;
    function atualizarEscuta() {
        const path = `escola/${document.getElementById('turma').value}/${document.getElementById('testeID').value}`;
        const oficial = document.getElementById('gabaritoOficial').value.toUpperCase();
        if (refAtiva) refAtiva.off();
        refAtiva = db.ref(path);

        refAtiva.on('value', (snap) => {
            const lista = document.getElementById('listaAlunos');
            const diag = document.getElementById('diagHabilidades');
            lista.innerHTML = ""; diag.innerHTML = "";
            let somaP = 0, totalA = 0, errosH = { "D041": 0, "D042": 0, "D025": 0, "D095": 0 };

            snap.forEach((child) => {
                const d = child.val(); totalA++;
                const porc = ((d.acertos / d.total) * 100);
                somaP += porc;
                if(d.falha && d.falha !== "Nenhuma") errosH[d.falha]++;

                let boxes = "";
                for(let i=0; i < oficial.length; i++) {
                    const status = (d.respostas && d.respostas[i] === oficial[i]) ? 'acerto' : 'erro';
                    boxes += `<div class="questao-box ${status}">${i+1}</div>`;
                }

                lista.innerHTML += `
                    <div class="item-aluno">
                        <div class="aluno-topo" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'block' ? 'none' : 'block'">
                            <span><strong>${d.aluno}</strong> (${porc.toFixed(1)}%)</span>
                            <span>üîç</span>
                        </div>
                        <div class="detalhes-correcao">
                            <div style="margin-bottom:10px;">${boxes}</div>
                            <button style="width:auto; padding:5px 10px; background:#dc3545; color:white; border:none;" onclick="db.ref('${path}/${child.key}').remove()">üóëÔ∏è Excluir</button>
                        </div>
                    </div>`;
            });

            if (totalA > 0) {
                const mediaF = (somaP / totalA).toFixed(1);
                document.getElementById('txtMedia').innerText = mediaF + "%";
                document.getElementById('barraMedia').style.width = mediaF + "%";

                Object.keys(errosH).forEach(h => {
                    const pErro = ((errosH[h] / totalA) * 100).toFixed(0);
                    diag.innerHTML += `
                        <div style="display:flex; justify-content:space-between; font-size:13px; margin-top:10px;">
                            <span>${h} - ${habilidades[h]}</span><span>${pErro}% de defasagem</span>
                        </div>
                        <div class="barra-fundo"><div style="background:#dc3545; height:100%; width:${pErro}%"></div></div>`;
                });
            }
        });
    }
</script>
</body>
</html>
