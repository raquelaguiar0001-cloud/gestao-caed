<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Scanner CAEd Realtime | Raquel Aguiar</title>
    <link rel="icon" href="https://fav.farm/ðŸ“Š" />
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        .card { background: white; border-radius: 15px; padding: 20px; max-width: 600px; margin: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #video { width: 100%; border-radius: 10px; background: #000; display: none; }
        canvas { display: none; }
        .controles { margin: 15px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn { background: #007bff; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
        .status-cam { color: #28a745; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ðŸ“¸ Scanner de Gabarito Ativo</h2>
    <div id="camStatus" class="status-cam">CÃ¢mera Desativada</div>
    
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <div class="controles">
        <select id="turma">
            <option value="8ano">8Âº Ano</option>
            <option value="9ano">9Âº Ano</option>
        </select>
        <input type="text" id="testeNome" placeholder="Ex: Teste1">
        <input type="text" id="gabaritoOficial" placeholder="Gabarito Oficial (letras)">
    </div>

    <div class="controles">
        <button class="btn" onclick="ativarCamera()">ðŸŽ¥ Abrir CÃ¢mera</button>
        <button class="btn" style="background:#28a745" onclick="capturarEFitrar()">ðŸŽ¯ Escanear Agora</button>
    </div>
    
    <div id="resultadoLeitura"></div>
</div>

<script>
    // ConfiguraÃ§Ã£o para o seu banco na Europa
    const firebaseConfig = { databaseURL: "https://gestao-caed-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');

    async function ativarCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            video.style.display = "block";
            document.getElementById('camStatus').innerText = "CÃ¢mera Ativa âœ…";
        } catch (err) {
            alert("Erro ao acessar cÃ¢mera: " + err);
        }
    }

    function capturarEFitrar() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Aqui o sistema processa os pixels para achar as bolinhas
        // Para este protÃ³tipo, vamos pedir o nome e simular a leitura dos acertos
        const nome = prompt("Confirme o nome do aluno para salvar a foto capturada:");
        if(!nome) return;

        processarESalvar(nome);
    }

    function processarESalvar(nome) {
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeNome').value || "Teste_Geral";
        
        // Sincroniza com o Firebase preservando todos os dados
        db.ref(`escola/${turma}/${teste}`).push({
            aluno: nome,
            data: 20260218, // Formato numÃ©rico solicitado
            status: "Escaneado via CÃ¢mera"
        }).then(() => {
            alert("Dados de " + nome + " enviados para o Firebase!");
        });
    }
</script>
</body>
</html>
