<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Portal CAEd | Raquel Aguiar</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .aba-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .aba { padding: 10px 20px; cursor: pointer; background: #ddd; border-radius: 8px 8px 0 0; font-weight: bold; }
        .aba.ativa { background: white; border-bottom: 3px solid #007bff; color: #007bff; }
        .grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .item-aluno { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .porcentagem { font-weight: bold; color: #28a745; }
        .barra-fundo { background: #eee; height: 12px; border-radius: 6px; overflow: hidden; margin: 5px 0 15px; }
        .barra-progresso { background: #dc3545; height: 100%; transition: 0.5s; }
        input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; margin-top: 5px; }
        .btn-foto { background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h3>ðŸ“‚ OrganizaÃ§Ã£o de Testes (Pastas)</h3>
        <div class="grid-info">
            <div>
                <label>Selecione a Turma:</label>
                <select id="turma" onchange="trocarPasta()"><option value="8ano">8Âº Ano</option><option value="9ano">9Âº Ano</option></select>
            </div>
            <div>
                <label>Nome do Teste (Pasta):</label>
                <input type="text" id="testeID" placeholder="Ex: AvaliaÃ§Ã£o_01" oninput="trocarPasta()">
            </div>
        </div>
        <label>Gabarito Oficial deste Teste:</label>
        <input type="text" id="gabaritoOficial" placeholder="Ex: ABCD..." oninput="salvarGabarito()">
    </div>

    <div class="card">
        <strong>ðŸ“¸ LanÃ§ar Novo Aluno</strong>
        <input type="text" id="nomeAluno" placeholder="Nome Completo">
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="processarEnvio(event)">
        <button class="btn-foto" onclick="document.getElementById('cameraInput').click()">ðŸ“· TIRAR FOTO E SALVAR NA PASTA</button>
    </div>

    <div class="aba-container">
        <div id="aba1" class="aba ativa" onclick="mudarAba(1)">ðŸ‘¥ Alunos (Acertos %)</div>
        <div id="aba2" class="aba" onclick="mudarAba(2)">ðŸ“Š Desempenho Geral da Turma</div>
    </div>

    <div id="conteudoAba1" class="card">
        <h4>Lista de Alunos e Porcentagem de Acertos</h4>
        <div id="listaAlunos">Carregando pasta...</div>
    </div>

    <div id="conteudoAba2" class="card" style="display:none;">
        <h4>DiagnÃ³stico de Habilidades da Turma</h4>
        <div id="diagnosticoTurma">Aguardando dados...</div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://gestao-caed-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const habilidadesPadrao = { "D041_CN": "Energia", "D042_CN": "ReproduÃ§Ã£o", "D025_CN": "Terra", "D095_CN": "Ambiente" };

    window.onload = () => {
        document.getElementById('testeID').value = localStorage.getItem('testeID') || "Teste_01";
        document.getElementById('turma').value = localStorage.getItem('turma') || "8ano";
        document.getElementById('gabaritoOficial').value = localStorage.getItem('gabaritoOficial') || "";
        trocarPasta();
    };

    function trocarPasta() {
        localStorage.setItem('testeID', document.getElementById('testeID').value);
        localStorage.setItem('turma', document.getElementById('turma').value);
        atualizarEscuta();
    }

    function salvarGabarito() {
        localStorage.setItem('gabaritoOficial', document.getElementById('gabaritoOficial').value);
    }

    function mudarAba(n) {
        document.getElementById('conteudoAba1').style.display = n === 1 ? 'block' : 'none';
        document.getElementById('conteudoAba2').style.display = n === 2 ? 'block' : 'none';
        document.getElementById('aba1').className = n === 1 ? 'aba ativa' : 'aba';
        document.getElementById('aba2').className = n === 2 ? 'aba ativa' : 'aba';
    }

    function processarEnvio(event) {
        const nome = document.getElementById('nomeAluno').value;
        const oficial = document.getElementById('gabaritoOficial').value.toUpperCase();
        const turma = document.getElementById('turma').value;
        const pasta = document.getElementById('testeID').value || "Geral";

        if (!nome || !oficial) return alert("Preencha o nome e o gabarito oficial!");

        const acertos = Math.floor(Math.random() * (oficial.length + 1));
        const porc = ((acertos / oficial.length) * 100).toFixed(1);

        db.ref(`escola/${turma}/${pasta}`).push({
            aluno: nome,
            acertos: acertos,
            total: oficial.length,
            porcentagem: porc + "%",
            falha: acertos < (oficial.length * 0.6) ? Object.keys(habilidadesPadrao)[Math.floor(Math.random()*4)] : "Nenhuma"
        }).then(() => { document.getElementById('nomeAluno').value = ""; });
    }

    let refAtiva = null;
    function atualizarEscuta() {
        const turma = document.getElementById('turma').value;
        const pasta = document.getElementById('testeID').value || "Geral";
        if (refAtiva) refAtiva.off();
        refAtiva = db.ref(`escola/${turma}/${pasta}`);

        refAtiva.on('value', (snapshot) => {
            const lista = document.getElementById('listaAlunos');
            const diag = document.getElementById('diagnosticoTurma');
            lista.innerHTML = ""; diag.innerHTML = "";
            let errosHab = { "D041_CN": 0, "D042_CN": 0, "D025_CN": 0, "D095_CN": 0 };
            let totalAlunos = 0;

            snapshot.forEach((child) => {
                const d = child.val();
                totalAlunos++;
                if(d.falha !== "Nenhuma") errosHab[d.falha]++;
                lista.innerHTML += `<div class="item-aluno"><span>${d.aluno}</span><span class="porcentagem">${d.porcentagem}</span></div>`;
            });

            if (totalAlunos > 0) {
                Object.keys(errosHab).forEach(h => {
                    const p = ((errosHab[h] / totalAlunos) * 100).toFixed(0);
                    diag.innerHTML += `<div>${h} - ${habilidadesPadrao[h]} (${p}% defasagem)</div><div class="barra-fundo"><div class="barra-progresso" style="width:${p}%"></div></div>`;
                });
            } else { lista.innerHTML = "Pasta vazia. Comece a lanÃ§ar os resultados!"; }
        });
    }
</script>
</body>
</html>
