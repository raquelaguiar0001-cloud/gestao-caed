<div class="container">
    <div class="card">
        <h3>ðŸ“‚ SeleÃ§Ã£o de Turma e Teste</h3>
        <select id="turma" onchange="trocarPasta()">
            <option value="8ano">8Âº Ano</option>
            <option value="9ano">9Âº Ano</option>
        </select>

        <div class="prova-grid">
            <div class="prova-bloco" onclick="selecionarTeste('Teste 01 CAED')"><span>Teste 01<br>CAED</span></div>
            <div class="prova-bloco" onclick="selecionarTeste('Teste 02 CAED')"><span>Teste 02<br>CAED</span></div>
            <div class="prova-bloco" onclick="selecionarTeste('Teste 01 AVA 1 BIM')"><span>Teste 01<br>AVA 1 BIM</span></div>
        </div>
        
        <input type="hidden" id="testeID">
        <input type="text" id="gabaritoOficial" placeholder="Gabarito (Ex: 1D-2B-3A...)" oninput="salvarGabarito()">
    </div>

    <div class="card">
        <strong>ðŸ“¸ Scanner do Aluno</strong>
        <input type="text" id="nomeAluno" placeholder="Nome do Aluno">
        <button class="btn-foto" onclick="document.getElementById('cameraInput').click()">ðŸ“· TIRAR FOTO E CORRIGIR</button>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="processarCorrecaoReal(event)">
    </div>

    <div class="aba-container">
        <div id="aba1" class="aba ativa" onclick="mudarAba(1)">ðŸ‘¥ Alunos</div>
        <div id="aba2" class="aba" onclick="mudarAba(2)">ðŸ“Š Desempenho Geral</div>
    </div>

    <div id="contAba1" class="card">
        <div id="listaAlunos">Carregando alunos...</div>
    </div>

    <div id="contAba2" class="card" style="display:none;">
        <h4>MÃ©dia de Acertos da Turma</h4>
        <div style="background: #eee; border-radius: 10px; height: 30px; width: 100%; overflow: hidden; margin: 10px 0;">
            <div id="barraProgresso" style="background: #28a745; height: 100%; width: 0%; transition: 0.5s; text-align: center; color: white; line-height: 30px; font-weight: bold;">0%</div>
        </div>
        <p id="statsGeral" style="text-align: center; font-size: 14px; color: #555;"></p>
    </div>
</div>

<style>
    .prova-grid { display: flex; gap: 10px; margin-bottom: 15px; }
    .prova-bloco { flex: 1; border: 2px solid #333; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; font-size: 13px; background: white; }
    .prova-bloco.selecionado { background: #007bff; color: white; border-color: #0056b3; }
    /* Estilos anteriores mantidos */
</style>

<script>
    // ... (FunÃ§Ãµes de inicializaÃ§Ã£o e Firebase mantidas)

    function selecionarTeste(nome) {
        document.getElementById('testeID').value = nome;
        document.querySelectorAll('.prova-bloco').forEach(b => b.classList.remove('selecionado'));
        event.currentTarget.classList.add('selecionado');
        atualizarEscuta();
    }

    function atualizarEscuta() {
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeID').value;
        if(!teste) return;

        const path = `escola/${turma}/${teste}`;
        const oficial = extrairGabarito(document.getElementById('gabaritoOficial').value);
        
        db.ref(path).on('value', (snap) => {
            const lista = document.getElementById('listaAlunos');
            lista.innerHTML = "";
            
            let totalAcertosTurma = 0;
            let totalAlunos = 0;

            snap.forEach((child) => {
                const d = child.val();
                totalAcertosTurma += d.acertos;
                totalAlunos++;

                // Monta os quadradinhos individuais
                let boxes = "";
                for(let i=0; i < oficial.length; i++) {
                    const status = (d.respostas && d.respostas[i] === oficial[i]) ? 'acerto' : 'erro';
                    boxes += `<div class="questao-box ${status}">${i+1}</div>`;
                }

                lista.innerHTML += `
                    <div style="border-bottom:1px solid #eee; padding:15px 0;">
                        <button class="btn-del" onclick="db.ref('${path}/${child.key}').remove()">Excluir</button>
                        <strong>${d.aluno}</strong> - Acertos: ${d.acertos}/${oficial.length}
                        <div style="margin-top:8px;">${boxes}</div>
                    </div>`;
            });

            // Atualiza Barra de Desempenho Geral (Aba 2)
            if(totalAlunos > 0 && oficial.length > 0) {
                const mediaGeral = (totalAcertosTurma / (totalAlunos * oficial.length)) * 100;
                const barra = document.getElementById('barraProgresso');
                barra.style.width = mediaGeral.toFixed(0) + "%";
                barra.innerText = mediaGeral.toFixed(0) + "%";
                document.getElementById('statsGeral').innerText = `MÃ©dia da turma baseada em ${totalAlunos} alunos.`;
            }
        });
    }
</script>
