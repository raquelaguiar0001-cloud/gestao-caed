<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema CAEd Pro | Raquel Aguiar</title>
    <link rel="icon" href="https://fav.farm/ðŸ“Š" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .card { background: white; border-radius: 15px; padding: 25px; max-width: 800px; margin: 20px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .flex { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; }
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        .btn { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-verde { background: #28a745; }
        #graficoArea { min-height: 300px; }
    </style>
</head>
<body>

<div class="card">
    <h1>ðŸ“Š Gestor de AvaliaÃ§Ãµes CAEd</h1>
    <p>Sincronizado com: <code id="db-url">Realtime Database (EU)</code></p>

    <div class="flex">
        <select id="turma">
            <option value="8ano">8Âº Ano</option>
            <option value="9ano">9Âº Ano</option>
        </select>
        <input type="text" id="testeNome" placeholder="Ex: Teste1">
        <input type="text" id="gabaritoOficial" placeholder="Gabarito (ex: ABCDE...)">
    </div>

    <div class="flex">
        <input type="text" id="nomeAluno" placeholder="Nome do Aluno" style="width: 60%;">
        <button class="btn" onclick="salvarResultado()">LanÃ§ar e Comparar</button>
    </div>
</div>

<div class="card" id="graficoArea">
    <h3>ðŸ“ˆ Comparativo: Aluno vs MÃ©dia da Turma</h3>
    <canvas id="graficoComparativo"></canvas>
</div>

<script>
    // ConfiguraÃ§Ã£o oficial para seu banco na Europa
    const firebaseConfig = { databaseURL: "https://gestao-caed-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let chartInstance = null;

    function salvarResultado() {
        const turma = document.getElementById('turma').value;
        const teste = document.getElementById('testeNome').value || "Teste1";
        const nome = document.getElementById('nomeAluno').value;
        const gabarito = document.getElementById('gabaritoOficial').value.toUpperCase();

        if(!nome || !gabarito) return alert("Preencha o nome e o gabarito!");

        // SimulaÃ§Ã£o de correÃ§Ã£o (Sorteia uma nota para o teste)
        const notaAlcancada = Math.floor(Math.random() * 11); 

        // Salva organizado por Turma -> Teste -> Aluno
        db.ref(`escola/${turma}/${teste}`).push({
            aluno: nome,
            nota: notaAlcancada,
            data: 20260218 // Seu formato preferido
        }).then(() => {
            alert(`Nota ${notaAlcancada} salva para ${nome} no ${teste}!`);
            carregarDadosComparativos(turma, teste, nome, notaAlcancada);
        });
    }

    function carregarDadosComparativos(turma, teste, nomeAtual, notaAtual) {
        db.ref(`escola/${turma}/${teste}`).once('value', (snapshot) => {
            const dados = snapshot.val();
            if(!dados) return;

            const notas = Object.values(dados).map(d => d.nota);
            const soma = notas.reduce((a, b) => a + b, 0);
            const mediaTurma = (soma / notas.length).toFixed(1);

            desenharGrafico(nomeAtual, notaAtual, mediaTurma);
        });
    }

    function desenharGrafico(aluno, nota, media) {
        const ctx = document.getElementById('graficoComparativo').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [aluno, 'MÃ©dia da Turma'],
                datasets: [{
                    label: 'Desempenho no Teste',
                    data: [nota, media],
                    backgroundColor: ['#007bff', '#ffc107']
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, max: 10 } }
            }
        });
    }
</script>
</body>
</html>
