<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Scanner PrecisÃ£o 100% | Raquel Aguiar</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .prova-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin-top: 15px; }
        .prova-bloco { border: 2px solid #333; border-radius: 8px; padding: 15px 5px; text-align: center; cursor: pointer; font-weight: bold; background: white; font-size: 12px; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .prova-bloco.selecionado { background: #007bff; color: white; border-color: #0056b3; }
        .upload-area { border: 2px dashed #ccc; padding: 15px; text-align: center; margin: 10px 0; cursor: pointer; background: #fafafa; border-radius: 8px; color: #666; font-size: 13px; }
        .aba-container { display: flex; gap: 10px; margin-bottom: 10px; width: 100%; }
        .aba { flex: 1; padding: 12px; text-align: center; cursor: pointer; background: #ddd; border-radius: 8px; font-weight: bold; }
        .aba.ativa { background: #007bff; color: white; }
        .grade-questoes { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .questao-box { width: 35px; height: 35px; line-height: 35px; text-align: center; border-radius: 6px; font-weight: bold; color: white !important; font-size: 14px; }
        .acerto { background-color: #28a745 !important; border: 1px solid #1e7e34 !important; }
        .erro { background-color: #dc3545 !important; border: 1px solid #bd2130 !important; }
        input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #ccc; width: 100%; margin-top: 5px; box-sizing: border-box; }
        .btn-foto { background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 15px; }
        .btn-excluir { background: #ff4d4d; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; float: right; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <h3>ðŸ“‚ ConfiguraÃ§Ã£o do Teste</h3>
        <select id="turma" onchange="atualizarEscuta()">
            <option value="8ano">8Âº Ano</option>
            <option value="9ano">9Âº Ano</option>
        </select>
        <div id="gridTestes" class="prova-grid"></div>
        <div class="upload-area" tabindex="0" onpaste="colarImagem(event, 'previewOficial', 'imgOficial')">
            <span>Clique aqui e Cole (Ctrl+V) a FOTO DO GABARITO OFICIAL</span>
            <img id="previewOficial" style="display:none; max-width: 100%; margin-top:10px; border-radius: 8px;">
            <input type="hidden" id="imgOficial">
        </div>
        <input type="text" id="gabaritoOficial" placeholder="Gabarito Oficial (Ex: ABCDE...)" oninput="salvarGabarito()" style="margin-top: 15px; border: 2px solid #007bff;">
    </div>

    <div class="card">
        <strong>ðŸ“¸ Scanner e Entrada do Aluno</strong>
        <input type="text" id="nomeAluno" placeholder="Nome do Aluno">
        <div class="upload-area" tabindex="0" onpaste="colarImagem(event, 'previewAluno', 'imgAluno')">
            <span>Clique aqui e Cole (Ctrl+V) a FOTO DO ALUNO</span>
            <img id="previewAluno" style="display:none; max-width: 100%; margin-top:10px; border-radius: 8px;">
            <input type="hidden" id="imgAluno">
        </div>
        <input type="text" id="gabaritoDigitadoAluno" placeholder="Respostas (Ex: 1A 2B ou ABCD)">
        <button class="btn-foto" onclick="processarCorrecao()">âœ… SALVAR E CORRIGIR AGORA</button>
    </div>

    <div class="aba-container">
        <div id="aba1" class="aba ativa" onclick="mudarAba(1)">ðŸ‘¥ Alunos</div>
        <div id="aba2" class="aba" onclick="mudarAba(2)">ðŸ“Š Desempenho</div>
    </div>

    <div id="contAba1" class="card"><div id="listaAlunos">Sincronizando...</div></div>
    <div id="contAba2" class="card" style="display:none;"><div id="barraProgresso" style="background: #28a745; height: 30px; width: 0%; color: white; text-align: center; border-radius: 5px;">0%</div><p id="statsGeral" style="text-align: center; margin-top:10px;"></p></div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://gestao-caed-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // FunÃ§Ã£o que garante que sÃ³ sobram as letras A, B, C, D ou E
    function limparDados(txt) { 
        return txt ? txt.toUpperCase().replace(/[^A-E]/g, '') : ""; 
    }

    window.onload = () => {
        renderizarBlocos();
        selecionarTeste(localStorage.getItem('testeID') || "Teste 01 CAED");
        document.getElementById('gabaritoOficial').value = localStorage.getItem('gabaritoOficial') || "";
    };

    function salvarGabarito() {
        localStorage.setItem('gabaritoOficial', document.getElementById('gabaritoOficial').value);
        atualizarEscuta();
    }

    function renderizarBlocos() {
        const grid = document.getElementById('gridTestes');
        const provas = ["Teste 01 CAED", "Teste 02 CAED", "Teste 01 AVA 1 BIM"];
        grid.innerHTML = "";
        provas.forEach(p => {
            const sel = localStorage.getItem('testeID') === p ? 'selecionado' : '';
            grid.innerHTML += `<div class="prova-bloco ${sel}" onclick="selecionarTeste('${p}')">${p}</div>`;
        });
    }

    function selecionarTeste(nome) {
        localStorage.setItem('testeID', nome);
        renderizarBlocos();
        atualizarEscuta();
    }

    function colarImagem(event, previewId, hiddenId) {
        const item = (event.clipboardData || event.originalEvent.clipboardData).items[0];
        if (item && item.type.indexOf("image") !== -1) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(previewId).src = e.target.result;
                document.getElementById(previewId).style.display = "block";
                document.getElementById(hiddenId).value = e.target.result;
            };
            reader.readAsDataURL(item.getAsFile());
        }
    }

    function processarCorrecao() {
        const nome = document.getElementById('nomeAluno').value.toUpperCase();
        const oficial = limparDados(document.getElementById('gabaritoOficial').value);
        const alunoRes = limparDados(document.getElementById('gabaritoDigitadoAluno').value);
        const testeID = localStorage.getItem('testeID');
        const turma = document.getElementById('turma').value;

        if(!nome || oficial.length === 0) return alert("Preencha Nome e Gabarito Oficial!");

        // Salvando jÃ¡ limpo para nÃ£o ter erro de comparaÃ§Ã£o depois
        db.ref(`escola/${turma}/${testeID}`).push({
            aluno: nome,
            respostas: alunoRes 
        }).then(() => {
            document.getElementById('nomeAluno').value = "";
            document.getElementById('gabaritoDigitadoAluno').value = "";
            document.getElementById('previewAluno').style.display = "none";
        });
    }

    function atualizarEscuta() {
        const turma = document.getElementById('turma').value;
        const testeID = localStorage.getItem('testeID');
        const oficial = limparDados(document.getElementById('gabaritoOficial').value);
        
        db.ref(`escola/${turma}/${testeID}`).on('value', (snap) => {
            const lista = document.getElementById('listaAlunos');
            lista.innerHTML = "";
            let somaAcertos = 0; let somaTotal = 0;

            snap.forEach((child) => {
                const d = child.val();
                const resA = limparDados(d.respostas);
                let acertosCalc = 0;
                let boxes = "";
                
                // Compara letra por letra baseado no tamanho do oficial
                for(let i=0; i < oficial.length; i++) {
                    const letraAluno = resA[i] || "";
                    const letraOficial = oficial[i];
                    const correta = (letraAluno === letraOficial && letraAluno !== "");
                    
                    if(correta) acertosCalc++;
                    boxes += `<div class="questao-box ${correta ? 'acerto' : 'erro'}">${i+1}</div>`;
                }

                somaAcertos += acertosCalc;
                somaTotal += oficial.length;

                lista.innerHTML += `
                    <div style="border-bottom: 2px solid #eee; padding: 15px 0;">
                        <button class="btn-excluir" onclick="db.ref('escola/${turma}/${testeID}/${child.key}').remove()">Excluir</button>
                        <strong>${d.aluno}</strong> - Resultado: ${acertosCalc}/${oficial.length}
                        <div class="grade-questoes">${boxes}</div>
                    </div>`;
            });
            const p = somaTotal > 0 ? (somaAcertos/somaTotal)*100 : 0;
            document.getElementById('barraProgresso').style.width = p+"%";
            document.getElementById('barraProgresso').innerText = Math.round(p)+"%";
            document.getElementById('statsGeral').innerText = `MÃ©dia da Turma: ${Math.round(p)}% (${snap.numChildren()} alunos)`;
        });
    }

    function mudarAba(n) {
        document.getElementById('contAba1').style.display = n === 1 ? 'block' : 'none';
        document.getElementById('contAba2').style.display = n === 2 ? 'block' : 'none';
        document.getElementById('aba1').className = n === 1 ? 'aba ativa' : 'aba';
        document.getElementById('aba2').className = n === 2 ? 'aba ativa' : 'aba';
    }
</script>
</body>
</html>
